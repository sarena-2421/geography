<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>108課綱學測地理模擬App</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #ecfdf5; } /* Emerald-50 */
        .font-serif { font-family: 'Noto Serif TC', serif; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 自定義捲軸 */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #d1fae5; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #34d399; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #059669; }
        
        /* 複選題 Checkbox 樣式優化 */
        .checkbox-ring { transition: all 0.2s; }
    </style>
</head>
<body class="h-screen w-full flex justify-center items-center overflow-hidden text-slate-800">
    <div id="root" class="w-full h-full max-w-md bg-[#fafffd] shadow-2xl relative flex flex-col border-x border-slate-200"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // -----------------------------------------------------------------------------
        // 0. 地理風格圖標 (Lucide Icons)
        // -----------------------------------------------------------------------------
        const Icons = {
            Map: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></svg>,
            Mountain: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m8 3 4 8 5-5 5 15H2L8 3z"/></svg>,
            Compass: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></svg>,
            Layers: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>,
            CheckCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            XCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="15" x2="9" y1="9" y2="15"/><line x1="9" x2="15" y1="9" y2="15"/></svg>,
            ChevronLeft: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="15 18 9 12 15 6"/></svg>,
            ChevronRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="9 18 15 12 9 6"/></svg>,
            Flag: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15"/></svg>,
            Grid: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
            RefreshCw: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
            CheckSquare: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>,
            Square: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>
        };

        const { Map, Mountain, Compass, Layers, CheckCircle, XCircle, ChevronLeft, ChevronRight, Flag, Grid, RefreshCw, CheckSquare, Square } = Icons;

        // -----------------------------------------------------------------------------
        // 1. 地理資料庫 (Geography Database)
        // -----------------------------------------------------------------------------

        const PHYSICAL_GEOGRAPHY = [
            { topic: '地形系統', key: '沖積扇', desc: '河流流出谷口，因坡度變緩流速降低，泥沙堆積呈扇狀。', fake: ['三角洲', '氾濫平原', '曲流'] },
            { topic: '氣候系統', key: '行星風系', desc: '受太陽輻射與地球自轉影響，形成全球性的風帶與氣壓帶分佈。', fake: ['季風系統', '地方風系', '焚風'] },
            { topic: '地圖資訊', key: 'GIS', desc: '地理資訊系統，用於蒐集、儲存、分析與展示空間資料的電腦系統。', fake: ['GPS', 'RS', 'LBS'] },
            { topic: '水文系統', key: '透水層', desc: '岩層孔隙大，地下水容易滲透流動的岩層，如砂岩、礫岩。', fake: ['不透水層', '受壓水層', '地下水面'] }
        ];

        const HUMAN_GEOGRAPHY = [
            { topic: '人口地理', key: '扶養比', desc: '（幼年人口+老年人口）/ 壯年人口 × 100%。反映社會的經濟負擔。', fake: ['性別比', '人口密度', '老化指數'] },
            { topic: '產業活動', key: '韋伯工業區位', desc: '強調「運輸成本」最小化，考慮原料與產品的重量及運費。', fake: ['邱念圈', '中地理論', '產品生命週期'] },
            { topic: '都市系統', key: '中地理論', desc: '克里斯徒勒提出，解釋聚落大小、數量與分佈的規律，強調「商品圈」與「商閾」。', fake: ['同心圓模式', '扇形模式', '多核心模式'] }
        ];

        // -----------------------------------------------------------------------------
        // 2. 隨機題庫生成邏輯 (Generator)
        // -----------------------------------------------------------------------------

        const fisherYatesShuffle = (array) => {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        };

        const generateMockQuestions = (count) => {
            const allConcepts = [
                ...PHYSICAL_GEOGRAPHY.map(c => ({...c, category: '自然地理'})), 
                ...HUMAN_GEOGRAPHY.map(c => ({...c, category: '人文地理'}))
            ];
            
            const questions = [];

            for (let i = 0; i < count; i++) {
                const concept = allConcepts[Math.floor(Math.random() * allConcepts.length)];
                
                // 單選題模板
                const templates = [
                    {
                        q: `下列對於「${concept.key}」的描述，何者最為正確？`,
                        correct: concept.desc
                    },
                    {
                        q: `「${concept.desc}」這段文字最可能是在描述下列哪一個地理概念？`,
                        correct: concept.key
                    }
                ];
                const template = templates[Math.floor(Math.random() * templates.length)];

                let options = [];
                options.push({ text: template.correct, isCorrect: true });
                
                let distractors = [];
                if (template.q.includes(concept.key)) {
                   distractors = allConcepts.filter(c => c.key !== concept.key).map(c => c.desc);
                } else {
                   distractors = [...concept.fake];
                   while(distractors.length < 3) {
                       const randomC = allConcepts[Math.floor(Math.random() * allConcepts.length)];
                       if(randomC.key !== concept.key && !distractors.includes(randomC.key)) {
                           distractors.push(randomC.key);
                       }
                   }
                }
                
                fisherYatesShuffle(distractors).slice(0, 3).forEach(d => {
                    options.push({ text: d, isCorrect: false });
                });

                questions.push({
                    id: `gen_${i}_${Date.now()}`,
                    type: 'single',
                    category: concept.category,
                    text: template.q,
                    options: fisherYatesShuffle(options),
                    explanation: `解析：${concept.desc}`,
                    topic: concept.topic
                });
            }
            return questions;
        };

        // -----------------------------------------------------------------------------
        // 3. 真實/手寫精選題庫 (包含單選與複選)
        // -----------------------------------------------------------------------------
        const REAL_QUESTIONS = [
            {
                id: 'real_geo_1',
                type: 'single', // 單選
                category: '自然地理',
                topic: '地圖',
                text: '若要在地圖上呈現台灣各鄉鎮市區的「人口密度」高低，最適合使用下列哪一種統計地圖？',
                options: [
                    { text: '點子圖 (Dot Map)', isCorrect: false },
                    { text: '等值線圖 (Isoline Map)', isCorrect: false },
                    { text: '面量圖 (Choropleth Map)', isCorrect: true },
                    { text: '流線圖 (Flow Map)', isCorrect: false }
                ],
                explanation: '解析：面量圖（區域密度圖）利用色彩深淺或網紋疏密來表現行政區內的統計數據（如人口密度、各種率），最適合呈現平均分佈的概念。'
            },
            {
                id: 'real_geo_2',
                type: 'single',
                category: '人文地理',
                topic: '農業區位',
                text: '邱念 (Thunen) 的農業區位理論中，影響農業土地利用型態呈現「同心圓」分佈的最主要因素是什麼？',
                options: [
                    { text: '勞力成本', isCorrect: false },
                    { text: '土壤肥沃度', isCorrect: false },
                    { text: '市場距離與運費', isCorrect: true },
                    { text: '政策與氣候', isCorrect: false }
                ],
                explanation: '解析：邱念孤立國理論假設地形平坦、土壤均質，唯一變數是到市場的距離，因此運費決定了級差地租，形成以市場為中心的同心圓農業圈。'
            },
            {
                id: 'real_geo_3',
                type: 'multiple', // 複選題
                category: '區域地理',
                topic: '台灣地形',
                text: '台灣本島位於板塊交界處，地形複雜多樣。下列關於台灣地形特徵的敘述，哪些是正確的？（應選3項）',
                options: [
                    { text: '位於歐亞板塊與菲律賓海板塊的聚合帶', isCorrect: true },
                    { text: '東部海岸多為沙岸，西部海岸多為岩岸', isCorrect: false },
                    { text: '山脈走向大致與板塊擠壓方向垂直，呈南北縱走', isCorrect: true },
                    { text: '主要河川多發源於中央山脈，東西分流', isCorrect: true },
                    { text: '平原主要分布於東部，西部則以台地為主', isCorrect: false }
                ],
                explanation: '解析：B錯誤，應為東部多岩岸（斷層海岸）、西部多沙岸（堆積海岸）；E錯誤，平原主要分布於西部（如嘉南平原）。A、C、D皆為台灣地形正確特徵。'
            },
            {
                id: 'real_geo_4',
                type: 'multiple',
                category: '技術應用',
                topic: 'GPS應用',
                text: '全球衛星定位系統 (GPS) 已廣泛應用於日常生活中。下列哪些情境主要依賴 GPS 技術？（應選2項）',
                options: [
                    { text: '分析某地區近十年的土地利用變遷', isCorrect: false },
                    { text: '汽車導航系統規劃最佳路徑', isCorrect: true },
                    { text: '查詢公車即時到站位置', isCorrect: true },
                    { text: '利用雷達衛星影像監測地層下陷', isCorrect: false },
                    { text: '繪製全台登革熱確診病例分佈圖', isCorrect: false }
                ],
                explanation: '解析：B、C 皆需即時「定位」功能，屬 GPS 應用。A、D 屬於遙測 (RS) 與 GIS 的疊圖分析；E 為 GIS 的資料展示功能，不一定需要即時 GPS。'
            }
        ];

        // -----------------------------------------------------------------------------
        // 4. React Components
        // -----------------------------------------------------------------------------

        function App() {
            const [screen, setScreen] = useState('home'); // home, quiz, result
            const [questions, setQuestions] = useState([]);
            const [currentQIndex, setCurrentQIndex] = useState(0);
            
            // Ans State: 
            // Single: { qId: optionIndex }
            // Multiple: { qId: [optionIndex, optionIndex...] }
            const [answers, setAnswers] = useState({}); 
            const [marked, setMarked] = useState(new Set());
            const [showExplanation, setShowExplanation] = useState(false);
            const [showGrid, setShowGrid] = useState(false);

            // 初始化考卷
            const initExam = () => {
                const generated = generateMockQuestions(20); // 隨機生成20題單選
                const allQ = fisherYatesShuffle([...REAL_QUESTIONS, ...generated]);
                setQuestions(allQ);
                setAnswers({});
                setMarked(new Set());
                setCurrentQIndex(0);
                setShowExplanation(false);
                setScreen('quiz');
            };

            // 處理單選作答
            const handleSingleChoice = (optIndex) => {
                if (showExplanation) return; 
                const q = questions[currentQIndex];
                setAnswers(prev => ({ ...prev, [q.id]: optIndex }));
                setShowExplanation(true); // 單選立即顯示解析
            };

            // 處理複選作答 (Toggle)
            const handleMultiChoice = (optIndex) => {
                if (showExplanation) return;
                const q = questions[currentQIndex];
                setAnswers(prev => {
                    const currentSelected = prev[q.id] || [];
                    if (currentSelected.includes(optIndex)) {
                        return { ...prev, [q.id]: currentSelected.filter(i => i !== optIndex) };
                    } else {
                        return { ...prev, [q.id]: [...currentSelected, optIndex].sort() };
                    }
                });
            };

            // 複選題送出確認
            const submitMultiAnswer = () => {
                const q = questions[currentQIndex];
                if (!answers[q.id] || answers[q.id].length === 0) return; // 未選不能送
                setShowExplanation(true);
            };

            const toggleMark = () => {
                const q = questions[currentQIndex];
                setMarked(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(q.id)) newSet.delete(q.id);
                    else newSet.add(q.id);
                    return newSet;
                });
            };

            // 計算分數 (簡單制：全對才得分)
            const scoreData = useMemo(() => {
                if (questions.length === 0) return { score: 0, total: 0 };
                let correctCount = 0;
                let answeredCount = 0;
                
                questions.forEach(q => {
                    const ans = answers[q.id];
                    if (ans !== undefined) {
                        answeredCount++;
                        if (q.type === 'single') {
                            if (q.options[ans].isCorrect) correctCount++;
                        } else {
                            // 複選題核對邏輯：使用者選的 indices 必須等於所有正確選項的 indices
                            const userIndices = JSON.stringify(ans); // ans is already sorted in handleMultiChoice
                            const correctIndices = JSON.stringify(
                                q.options.map((o, i) => o.isCorrect ? i : -1).filter(i => i !== -1).sort()
                            );
                            if (userIndices === correctIndices) correctCount++;
                        }
                    }
                });
                return { correct: correctCount, answered: answeredCount, total: questions.length };
            }, [answers, questions]);

            // --- Home Screen ---
            if (screen === 'home') {
                return (
                    <div className="flex flex-col items-center justify-center h-full p-8 space-y-8 bg-[#ecfdf5]">
                        <div className="flex flex-col items-center space-y-4 animate-slide-up">
                            <div className="p-6 bg-emerald-600 rounded-full text-white shadow-xl ring-4 ring-emerald-200">
                                <Icons.Compass size={64} strokeWidth={1.5} />
                            </div>
                            <h1 className="text-4xl font-bold font-serif tracking-wide text-emerald-900">地理探索</h1>
                            <p className="text-slate-500 font-serif text-lg text-center">
                                108課綱 • 學測地理模擬<br/>
                                <span className="text-sm opacity-75 font-sans">自然 • 人文 • 區域 • 技術</span>
                            </p>
                        </div>
                        
                        <div className="w-full max-w-xs space-y-3 animate-fade-in" style={{animationDelay: '0.2s'}}>
                            <div className="flex justify-between text-xs text-slate-400 px-2 font-mono">
                                <span>Ver 1.5</span>
                                <span>單選 + 複選</span>
                            </div>
                            <button 
                                onClick={initExam}
                                className="w-full py-4 bg-emerald-800 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-emerald-700 active:scale-95 transition-all flex items-center justify-center gap-3"
                            >
                                <Icons.Map size={24} />
                                開始測驗
                            </button>
                            <div className="text-center text-xs text-slate-400 mt-4">
                                含混合題型模擬 • 即時解析
                            </div>
                        </div>
                    </div>
                );
            }

            // --- Result Screen ---
            if (screen === 'result') {
                const percent = Math.round((scoreData.correct / scoreData.total) * 100) || 0;
                return (
                    <div className="h-full flex flex-col bg-[#ecfdf5]">
                        <div className="flex-1 flex flex-col items-center justify-center p-8 space-y-8 animate-fade-in">
                            <h2 className="text-2xl font-serif font-bold text-emerald-900">測驗結果</h2>
                            
                            <div className="relative w-48 h-48 flex items-center justify-center">
                                <svg className="w-full h-full transform -rotate-90">
                                    <circle cx="96" cy="96" r="88" stroke="#d1fae5" strokeWidth="12" fill="none" />
                                    <circle cx="96" cy="96" r="88" stroke="#059669" strokeWidth="12" fill="none" 
                                        strokeDasharray={2 * Math.PI * 88}
                                        strokeDashoffset={2 * Math.PI * 88 * (1 - percent / 100)}
                                        className="transition-all duration-1000 ease-out"
                                    />
                                </svg>
                                <div className="absolute flex flex-col items-center">
                                    <span className="text-5xl font-serif font-bold text-emerald-800">{percent}</span>
                                    <span className="text-xs text-emerald-600 uppercase tracking-widest">Score</span>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4 w-full max-w-sm">
                                <div className="bg-white p-4 rounded-xl shadow-sm border border-emerald-100 text-center">
                                    <div className="text-xs text-slate-400 mb-1">答對題數</div>
                                    <div className="text-xl font-bold text-emerald-700">{scoreData.correct} <span className="text-sm text-slate-400">/ {scoreData.total}</span></div>
                                </div>
                                <div className="bg-white p-4 rounded-xl shadow-sm border border-emerald-100 text-center">
                                    <div className="text-xs text-slate-400 mb-1">答題率</div>
                                    <div className="text-xl font-bold text-emerald-700">{scoreData.answered} <span className="text-sm text-slate-400">/ {scoreData.total}</span></div>
                                </div>
                            </div>
                        </div>
                        <div className="p-6 bg-white border-t border-slate-100 pb-8">
                            <button onClick={() => setScreen('home')} className="w-full py-4 bg-slate-800 text-white rounded-xl font-bold shadow-md hover:bg-slate-700 transition flex items-center justify-center gap-2">
                                <Icons.RefreshCw size={20} /> 重返首頁
                            </button>
                        </div>
                    </div>
                );
            }

            // --- Quiz Screen ---
            const q = questions[currentQIndex];
            const isSingle = q.type === 'single';
            const userAnswer = answers[q.id]; 
            // isAnswered logic differs:
            // Single: userAnswer is not undefined
            // Multiple: showExplanation is true (user clicked confirm)
            const isSubmitted = showExplanation; 
            
            return (
                <div className="flex flex-col h-full bg-[#fafffd]">
                    {/* Header */}
                    <div className="h-16 bg-white/80 backdrop-blur-md border-b border-emerald-100 flex items-center justify-between px-4 shrink-0 shadow-sm z-10">
                        <button onClick={() => setScreen('home')} className="text-slate-400 hover:text-emerald-600 p-2">
                            <Icons.Map size={24} />
                        </button>
                        <div className="flex items-center gap-2">
                            <span className="px-2 py-0.5 bg-emerald-100 text-emerald-700 text-xs font-bold rounded">
                                {isSingle ? '單選' : '複選'}
                            </span>
                            <span className="font-serif font-bold text-lg text-emerald-900">Q{currentQIndex + 1}</span>
                        </div>
                        <button onClick={() => setShowGrid(true)} className="text-slate-400 hover:text-emerald-600 p-2">
                            <Icons.Grid size={24} />
                        </button>
                    </div>

                    {/* Content */}
                    <div className="flex-1 overflow-y-auto custom-scrollbar p-5 pb-32">
                        <div className="flex gap-2 mb-4">
                            <span className="px-3 py-1 bg-teal-50 text-teal-700 text-xs font-bold rounded-full tracking-wider border border-teal-100">
                                {q.category}
                            </span>
                            <span className="px-3 py-1 bg-slate-100 text-slate-600 text-xs rounded-full">
                                {q.topic}
                            </span>
                        </div>

                        <div className="mb-6">
                            <h3 className="text-xl font-serif font-medium leading-relaxed text-slate-900 text-justify">
                                {q.text}
                            </h3>
                        </div>

                        <div className="space-y-3">
                            {q.options.map((opt, idx) => {
                                let isSelected = false;
                                if (isSingle) {
                                    isSelected = userAnswer === idx;
                                } else {
                                    isSelected = (userAnswer || []).includes(idx);
                                }

                                let btnClass = "w-full p-4 rounded-xl border-2 text-left transition-all duration-200 flex items-start gap-3 relative ";
                                let iconClass = "mt-0.5 shrink-0 ";

                                if (isSubmitted) {
                                    // 已交卷模式
                                    if (opt.isCorrect) {
                                        // 正確答案 (綠色)
                                        btnClass += "border-emerald-500 bg-emerald-50 text-emerald-900";
                                        iconClass += "text-emerald-600";
                                    } else if (isSelected) {
                                        // 選錯了 (紅色)
                                        btnClass += "border-red-400 bg-red-50 text-red-900";
                                        iconClass += "text-red-500";
                                    } else {
                                        // 沒選且不是答案
                                        btnClass += "border-slate-100 text-slate-400 opacity-60";
                                        iconClass += "text-slate-300";
                                    }
                                } else {
                                    // 作答模式
                                    if (isSelected) {
                                        btnClass += "border-emerald-500 bg-emerald-50 text-emerald-900 shadow-sm";
                                        iconClass += "text-emerald-600";
                                    } else {
                                        btnClass += "border-slate-200 hover:border-emerald-300 hover:bg-white bg-white text-slate-700";
                                        iconClass += "text-slate-300";
                                    }
                                }

                                return (
                                    <button 
                                        key={idx} 
                                        onClick={() => isSingle ? handleSingleChoice(idx) : handleMultiChoice(idx)}
                                        disabled={isSubmitted}
                                        className={btnClass}
                                    >
                                        <div className={iconClass}>
                                            {isSingle ? (
                                                isSelected || (isSubmitted && opt.isCorrect) ? <Icons.CheckCircle size={20}/> : <div className="w-5 h-5 rounded-full border-2 border-current"/>
                                            ) : (
                                                isSelected || (isSubmitted && opt.isCorrect) ? <Icons.CheckSquare size={20}/> : <Icons.Square size={20}/>
                                            )}
                                        </div>
                                        <span className="text-base leading-relaxed">{opt.text}</span>
                                    </button>
                                );
                            })}
                        </div>

                        {/* 複選題送出按鈕 */}
                        {!isSingle && !isSubmitted && (
                            <button 
                                onClick={submitMultiAnswer}
                                className={`w-full mt-6 py-3 rounded-lg font-bold text-white transition-all ${
                                    (userAnswer && userAnswer.length > 0) ? 'bg-emerald-600 hover:bg-emerald-700 shadow-md' : 'bg-slate-300 cursor-not-allowed'
                                }`}
                            >
                                確認答案
                            </button>
                        )}

                        {/* 解析 */}
                        {showExplanation && (
                            <div className="mt-8 p-5 bg-slate-800 text-emerald-50 rounded-xl animate-fade-in shadow-lg border-l-4 border-emerald-500">
                                <div className="flex items-center gap-2 mb-2 text-emerald-400 font-bold">
                                    <Icons.Layers size={18} />
                                    <span>試題解析</span>
                                </div>
                                <p className="text-slate-300 leading-relaxed font-light">
                                    {q.explanation}
                                </p>
                            </div>
                        )}
                    </div>

                    {/* Bottom Nav */}
                    <div className="h-20 bg-white border-t border-emerald-100 px-6 flex items-center justify-between shrink-0 safe-area-bottom">
                         <button onClick={toggleMark} className={`p-3 rounded-full transition ${marked.has(q.id) ? 'bg-red-50 text-red-500' : 'text-slate-400 hover:bg-slate-100'}`}>
                            <Icons.Flag size={20} fill={marked.has(q.id) ? "currentColor" : "none"} />
                        </button>
                        <div className="flex gap-3">
                            <button 
                                onClick={() => { setShowExplanation(false); setCurrentQIndex(prev => Math.max(0, prev - 1)); }}
                                disabled={currentQIndex === 0}
                                className="px-5 py-3 rounded-lg text-slate-500 font-bold hover:bg-slate-100 disabled:opacity-30"
                            >
                                <Icons.ChevronLeft />
                            </button>
                            <button 
                                onClick={() => {
                                    if (currentQIndex < questions.length - 1) {
                                        setShowExplanation(false);
                                        setCurrentQIndex(prev => prev + 1);
                                    } else {
                                        setScreen('result');
                                    }
                                }}
                                className="px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-bold shadow-md flex items-center gap-2 transition"
                            >
                                {currentQIndex === questions.length - 1 ? '交卷' : '下一題'}
                                <Icons.ChevronRight size={18} />
                            </button>
                        </div>
                    </div>

                    {/* Grid Overlay */}
                    {showGrid && (
                        <div className="absolute inset-0 z-50 bg-slate-900/50 backdrop-blur-sm animate-fade-in flex justify-end">
                            <div className="w-80 bg-[#fafffd] h-full shadow-2xl flex flex-col animate-slide-up">
                                <div className="p-4 border-b border-slate-200 flex justify-between items-center bg-white">
                                    <h3 className="font-serif font-bold text-slate-800">題目導覽</h3>
                                    <button onClick={() => setShowGrid(false)} className="text-slate-400"><Icons.XCircle size={24}/></button>
                                </div>
                                <div className="p-4 grid grid-cols-5 gap-3 overflow-y-auto">
                                    {questions.map((qItem, idx) => {
                                        const isDone = answers[qItem.id] !== undefined;
                                        const isCurr = idx === currentQIndex;
                                        return (
                                            <button 
                                                key={qItem.id} 
                                                onClick={() => { setCurrentQIndex(idx); setShowExplanation(false); setShowGrid(false); }}
                                                className={`h-10 rounded-md font-bold text-sm relative ${
                                                    isCurr ? 'bg-white ring-2 ring-emerald-500 text-emerald-600' : 
                                                    isDone ? 'bg-emerald-700 text-white' : 'bg-slate-200 text-slate-500'
                                                }`}
                                            >
                                                {idx + 1}
                                                {marked.has(qItem.id) && <div className="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full ring-1 ring-white"/>}
                                            </button>
                                        )
                                    })}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>